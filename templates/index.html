<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sairam AI | Personal Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --sidebar-width: 280px;
            --bg-dark: #09090b;
            --bg-sidebar: #000000;
            --bg-input: #18181b;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.15);
            --text-main: #fafafa;
            --text-muted: #a1a1aa;
            --border: rgba(255, 255, 255, 0.08);
            --glass: rgba(255, 255, 255, 0.03);
            --header-height: 70px;
        }

        /* --- LIGHT MODE COLORS --- */
        body.light-mode {
            --bg-dark: #ffffff;
            --bg-sidebar: #f4f4f5;
            --bg-input: #f4f4f5;
            --text-main: #18181b;
            --text-muted: #71717a;
            --border: rgba(0, 0, 0, 0.1);
            --glass: rgba(0, 0, 0, 0.03);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        body { 
            background: var(--bg-dark); 
            color: var(--text-main); 
            height: 100dvh; 
            display: flex; 
            overflow: hidden; 
            transition: background 0.3s; 
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            height: 100%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        /* Desktop: Collapsed state */
        @media (min-width: 769px) {
            #sidebar.closed { margin-left: calc(var(--sidebar-width) * -1); }
        }

        /* Mobile: Hidden state */
        @media (max-width: 768px) {
            #sidebar {
                position: absolute; left: 0; top: 0;
                transform: translateX(-100%);
                width: 80%; max-width: 300px;
                box-shadow: 20px 0 50px rgba(0,0,0,0.5);
            }
            #sidebar.active { transform: translateX(0); }
            
            #sidebar-overlay {
                display: none; position: fixed; inset: 0;
                background: rgba(0,0,0,0.6); z-index: 900;
                backdrop-filter: blur(2px);
            }
            #sidebar-overlay.active { display: block; }
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        
        .new-chat-btn {
            width: 100%; padding: 12px; background: var(--accent);
            border: none; border-radius: 10px; color: white;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 10px; font-weight: 600; transition: transform 0.2s;
        }
        .new-chat-btn:active { transform: scale(0.98); }

        .chat-history { flex: 1; overflow-y: auto; padding: 15px; }
        .history-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; margin: 15px 0 10px 5px; text-transform: uppercase; }
        
        .history-item {
            padding: 12px 14px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; gap: 12px;
            color: var(--text-muted); margin-bottom: 4px; font-size: 0.9rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: 0.2s;
        }
        .history-item:hover { background: var(--glass); color: var(--text-main); }
        .history-item.active { background: var(--glass); color: var(--text-main); border: 1px solid var(--border); }

        /* --- MAIN CONTENT --- */
        main { flex: 1; display: flex; flex-direction: column; position: relative; height: 100%; min-width: 0; }
        
        #chat-header {
            height: var(--header-height); padding: 0 20px;
            border-bottom: 1px solid var(--border); display: flex;
            justify-content: space-between; align-items: center;
            background: var(--bg-dark); flex-shrink: 0;
        }

        .header-title { font-weight: 700; letter-spacing: 0.5px; font-size: 1.1rem; }
        .header-controls { display: flex; gap: 15px; font-size: 1.1rem; color: var(--text-muted); }
        .icon-btn { cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .icon-btn:hover { background: var(--glass); color: var(--text-main); }

        /* --- CHAT AREA --- */
        #chat-window {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 20px; display: flex; flex-direction: column;
            scroll-behavior: smooth;
        }

        .welcome-screen {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100%; text-align: center; padding: 20px;
        }
        .hero-title {
            font-size: 2.5rem; font-weight: 800;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; margin-bottom: 10px;
        }

        /* MESSAGES */
        .message-row {
            display: flex; gap: 15px; margin-bottom: 25px;
            max-width: 800px; margin-left: auto; margin-right: auto;
            width: 100%; animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .avatar {
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; flex-shrink: 0; font-size: 0.9rem;
        }
        .ai-avatar { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .user-avatar { background: #27272a; color: white; border: 1px solid var(--border); }

        .msg-content { flex: 1; line-height: 1.6; font-size: 1rem; color: var(--text-main); min-width: 0; }
        .msg-sender-name { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; font-weight: 600; letter-spacing: 0.5px; }
        .msg-content p { margin-bottom: 10px; }
        .msg-content pre { background: #121212; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid var(--border); margin: 10px 0; }
        .msg-content code { font-family: 'Fira Code', monospace; font-size: 0.9em; color: #a5b4fc; }
        
        /* Attachment Tag in Message */
        .attachment-tag {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(99, 102, 241, 0.1); color: var(--accent);
            padding: 4px 8px; border-radius: 4px; margin-top: 5px; font-size: 0.85rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        /* --- INPUT AREA --- */
        #input-area { padding: 20px; background: var(--bg-dark); flex-shrink: 0; }

        .input-container {
            max-width: 800px; margin: 0 auto;
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 16px; padding: 10px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative;
        }

        .input-controls { display: flex; align-items: flex-end; gap: 10px; width: 100%; }

        /* PREVIEW PILL */
        #attachment-preview {
            display: none; background: var(--glass);
            border: 1px solid var(--border); padding: 6px 12px;
            border-radius: 8px; font-size: 0.85rem; color: var(--text-main);
            align-self: flex-start; margin-bottom: 5px; align-items: center; gap: 8px;
        }
        #attachment-preview.active { display: flex; }
        .remove-file { cursor: pointer; color: var(--text-muted); }
        .remove-file:hover { color: #ef4444; }

        /* MENU WRAPPER */
        .attach-wrapper { position: relative; padding-bottom: 4px; padding-left: 5px; }
        
        .plus-btn {
            background: var(--glass); border: 1px solid var(--border);
            color: var(--text-muted); width: 36px; height: 36px;
            border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; font-size: 1rem;
        }
        .plus-btn:hover, .plus-btn.active { background: var(--accent); color: white; border-color: var(--accent); transform: rotate(90deg); }

        .attach-menu {
            position: absolute; bottom: 55px; left: 0;
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 12px; padding: 8px; display: flex; flex-direction: column;
            gap: 5px; min-width: 140px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            opacity: 0; transform: translateY(10px) scale(0.95);
            pointer-events: none; transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 50;
        }
        .attach-menu.show { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }

        .menu-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 12px; border: none; background: transparent;
            color: var(--text-main); border-radius: 8px; cursor: pointer;
            font-size: 0.9rem; text-align: left; transition: 0.2s;
        }
        .menu-item:hover { background: var(--glass); }
        .menu-item i { width: 20px; text-align: center; color: var(--accent); }

        textarea {
            flex: 1; background: transparent; border: none; outline: none;
            color: var(--text-main); resize: none; max-height: 150px;
            padding: 10px 0; font-size: 1rem; line-height: 1.5;
        }

        .send-btn {
            background: var(--accent); color: white; border: none;
            width: 38px; height: 38px; border-radius: 10px; cursor: pointer;
            flex-shrink: 0; display: flex; align-items: center;
            justify-content: center; transition: 0.2s; margin-bottom: 2px;
        }
        .send-btn:hover { filter: brightness(1.1); }

        .typing-dots::after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80% { content: ' ....'; } 100% { content: ' .....'; } }

    </style>
</head>
<body>

    <!-- HIDDEN INPUT FOR FILES/CAMERA -->
    <!-- We use one input and change attributes dynamically via JS -->
    <input type="file" id="hidden-file-input" style="display: none;">

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="startNewChat()">
                <i class="fa fa-plus"></i> New Conversation
            </button>
        </div>
        <div class="chat-history">
            <div class="history-label">Recent History</div>
            <div id="history-container"></div>
        </div>
    </aside>

    <main>
        <header id="chat-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="fa fa-bars icon-btn" onclick="toggleSidebar()" style="font-size: 1.2rem;"></i>
                <strong class="header-title">SAIRAM AI</strong>
            </div>
            <div class="header-controls">
                <i class="fa fa-sun icon-btn" onclick="toggleTheme()" title="Toggle Theme"></i>
                <i class="fa fa-trash-can icon-btn" onclick="clearAllData()" title="Clear Memory"></i>
            </div>
        </header>

        <div id="chat-window">
            <div id="welcome-msg" class="welcome-screen">
                <div class="avatar ai-avatar" style="width: 70px; height: 70px; font-size: 2rem; margin-bottom: 20px;">S</div>
                <h1 class="hero-title">Sairam AI</h1>
                <p style="color: var(--text-muted); margin-bottom: 30px;">How can I help you today?</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button class="history-item" onclick="quickPrompt('Plan a travel itinerary')" style="border: 1px solid var(--border);">Plan a travel itinerary</button>
                    <button class="history-item" onclick="quickPrompt('Write python code for snake game')" style="border: 1px solid var(--border);">Python Snake Game</button>
                </div>
            </div>
            <div id="messages-list"></div>
        </div>

        <div id="input-area">
            <div class="input-container">
                <!-- PREVIEW AREA (Shown when file is selected) -->
                <div id="attachment-preview">
                    <i id="preview-icon" class="fa fa-file"></i>
                    <span id="preview-name">file.txt</span>
                    <i class="fa fa-times remove-file" onclick="clearAttachment()"></i>
                </div>

                <div class="input-controls">
                    <!-- ATTACHMENT MENU -->
                    <div class="attach-wrapper">
                        <button id="plus-btn" class="plus-btn" onclick="toggleAttachMenu()">
                            <i class="fa fa-plus"></i>
                        </button>
                        <div id="attach-menu" class="attach-menu">
                            <button class="menu-item" onclick="triggerFilePicker('File')">
                                <i class="fa fa-file-lines"></i> Files
                            </button>
                            <button class="menu-item" onclick="triggerFilePicker('Photo')">
                                <i class="fa fa-image"></i> Photos
                            </button>
                            <button class="menu-item" onclick="triggerFilePicker('Camera')">
                                <i class="fa fa-camera"></i> Camera
                            </button>
                        </div>
                    </div>

                    <textarea id="user-input" placeholder="Message Sairam AI..." rows="1"></textarea>
                    
                    <button class="send-btn" onclick="handleInput()">
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let activeChatId = null;
        let db = JSON.parse(localStorage.getItem('sairam_db')) || { chats: [], theme: 'dark' };
        
        // --- FILE HANDLING STATE ---
        let selectedFile = null;

        const input = document.getElementById('user-input');
        const list = document.getElementById('messages-list');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const attachMenu = document.getElementById('attach-menu');
        const plusBtn = document.getElementById('plus-btn');
        const fileInput = document.getElementById('hidden-file-input');

        function init() {
            if (db.theme === 'light') document.body.classList.add('light-mode');
            renderHistory();

            // Auto-resize textarea
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                if(this.value === '') this.style.height = 'auto';
            });

            // Enter to send
            input.addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleInput();
                }
            });

            // Close menus when clicking outside
            document.addEventListener('click', (e) => {
                if (!plusBtn.contains(e.target) && !attachMenu.contains(e.target)) {
                    attachMenu.classList.remove('show');
                    plusBtn.classList.remove('active');
                }
            });

            // Handle File Selection
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    selectedFile = e.target.files[0];
                    showPreview(selectedFile);
                }
            });
        }

        /* --- UI HELPERS --- */
        function toggleSidebar() {
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('closed');
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            db.theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            saveDB();
        }

        function toggleAttachMenu() {
            attachMenu.classList.toggle('show');
            plusBtn.classList.toggle('active');
        }

        /* --- ATTACHMENT LOGIC --- */
        function triggerFilePicker(type) {
            toggleAttachMenu(); // Close menu
            
            // Reset input first
            fileInput.value = '';
            fileInput.removeAttribute('capture');
            
            // Configure input based on type
            if (type === 'File') {
                // For PDF/TXT
                fileInput.accept = ".pdf,.txt,.doc,.docx";
            } else if (type === 'Photo') {
                // For Images
                fileInput.accept = "image/*";
            } else if (type === 'Camera') {
                // For Camera (Mobile)
                fileInput.accept = "image/*";
                fileInput.setAttribute('capture', 'environment');
            }
            
            fileInput.click();
        }

        function showPreview(file) {
            const preview = document.getElementById('attachment-preview');
            const nameEl = document.getElementById('preview-name');
            const icon = document.getElementById('preview-icon');
            
            nameEl.innerText = file.name;
            preview.classList.add('active');
            
            if (file.type.startsWith('image/')) {
                icon.className = 'fa fa-image';
            } else {
                icon.className = 'fa fa-file-lines';
            }
        }

        function clearAttachment() {
            selectedFile = null;
            fileInput.value = '';
            document.getElementById('attachment-preview').classList.remove('active');
        }

        /* --- MESSAGING & BACKEND LOGIC --- */
        async function handleInput() {
            const text = input.value.trim();
            
            // Prevent empty send
            if (!text && !selectedFile) return;

            if (!activeChatId) startNewChat(text ? text.substring(0, 20) + "..." : "File Upload");

            // 1. UI: Append User Message
            let displayMsg = text;
            if (selectedFile) {
                const icon = selectedFile.type.startsWith('image/') ? 'ðŸ–¼ï¸' : 'ðŸ“„';
                displayMsg += `<br><div class="attachment-tag">${icon} ${selectedFile.name}</div>`;
            }
            appendMessage('user', displayMsg);

            // 2. Prepare FormData for Flask
            const formData = new FormData();
            
            if (text) {
                formData.append('message', text);
            }

            if (selectedFile) {
                // VITAL: Key matching for Flask backend
                // Python: request.files.get("image") OR request.files.get("file")
                if (selectedFile.type.startsWith('image/')) {
                    formData.append('image', selectedFile);
                } else {
                    formData.append('file', selectedFile);
                }
            }

            // 3. Clear UI Inputs
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('welcome-msg').style.display = 'none';
            const fileToSend = selectedFile; // Keep ref for error handling
            clearAttachment(); 

            // 4. Show Typing Indicator
            const typingId = "typing-" + Date.now();
            appendTypingIndicator(typingId);

            try {
                // 5. POST to Backend
                const response = await fetch('/chat', {
                    method: 'POST',
                    body: formData // Browser automatically sets Content-Type: multipart/form-data
                });

                if (!response.ok) throw new Error("Backend connection failed");

                const data = await response.json();
                document.getElementById(typingId).remove();
                
                // 6. Display AI Reply
                // Remove formatting stars if AI uses them excessively
                let cleanReply = data.reply.replace(/\*\*\*/g, '').replace(/\*\*/g, '');
                appendMessage('ai', cleanReply);
                saveToDB(displayMsg, cleanReply);

            } catch (error) {
                // Fallback / Error Handling
                console.warn(error);
                setTimeout(() => {
                    const el = document.getElementById(typingId);
                    if(el) el.remove();
                    
                    const errorMsg = "Unable to connect to Sairam AI backend. Please check if Flask is running on port 5000.";
                    appendMessage('ai', errorMsg);
                    saveToDB(displayMsg, errorMsg);
                }, 1000);
            }
        }

        function appendMessage(sender, text) {
            const row = document.createElement('div');
            row.className = 'message-row';
            
            let htmlContent = text.replace(/(?:\r\n|\r|\n)/g, '<br>');

            row.innerHTML = `
                <div class="avatar ${sender === 'ai' ? 'ai-avatar' : 'user-avatar'}">
                    ${sender === 'ai' ? 'S' : 'U'}
                </div>
                <div class="msg-content">
                    <div class="msg-sender-name">${sender === 'ai' ? 'SAIRAM AI' : 'YOU'}</div>
                    ${htmlContent}
                </div>
            `;
            list.appendChild(row);
            const win = document.getElementById('chat-window');
            win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
        }

        function appendTypingIndicator(id) {
            const row = document.createElement('div');
            row.className = 'message-row';
            row.id = id;
            row.innerHTML = `
                <div class="avatar ai-avatar">S</div>
                <div class="msg-content">
                    <div class="msg-sender-name">SAIRAM AI</div>
                    <div class="typing-dots" style="font-size: 1.2rem; line-height: 1;">.......</div>
                </div>
            `;
            list.appendChild(row);
            const win = document.getElementById('chat-window');
            win.scrollTop = win.scrollHeight;
        }

        function startNewChat(title = "New Conversation") {
            activeChatId = Date.now().toString();
            db.chats.unshift({ id: activeChatId, title: title, messages: [] });
            list.innerHTML = '';
            document.getElementById('welcome-msg').style.display = 'flex';
            
            // Close sidebar on mobile
            if(window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
            saveDB();
            renderHistory();
        }

        function saveToDB(uMsg, aMsg) {
            let chat = db.chats.find(c => c.id === activeChatId);
            if (chat) {
                chat.messages.push({ sender: 'user', text: uMsg }, { sender: 'ai', text: aMsg });
                saveDB();
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            container.innerHTML = db.chats.map(chat => `
                <div class="history-item ${chat.id === activeChatId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                    <i class="fa-regular fa-message"></i> ${chat.title}
                </div>
            `).join('');
        }

        function loadChat(id) {
            activeChatId = id;
            const chat = db.chats.find(c => c.id === id);
            list.innerHTML = '';
            document.getElementById('welcome-msg').style.display = 'none';
            chat.messages.forEach(m => appendMessage(m.sender, m.text));
            if(window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
            renderHistory();
        }

        function saveDB() { localStorage.setItem('sairam_db', JSON.stringify(db)); }
        function quickPrompt(t) { input.value = t; handleInput(); }
        function clearAllData() { 
            if(confirm("Clear all chat history?")) { 
                localStorage.removeItem('sairam_db'); 
                location.reload(); 
            } 
        }

        init();
    </script>
</body>
</html>